#!/bin/bash -exu

# Not able to resolve our import via shellcheck, so disable warning
# shellcheck disable=SC1091
source cf-deployment-concourse-tasks/shared-functions

function check_input_params() {
  if [ -z "$DEPLOYMENT_NAME" ]; then
    echo "DEPLOYMENT_NAME has not been set"
    exit 1
  fi
  if [ -z "$ERRAND_NAME" ]; then
    echo "ERRAND_NAME has not been set"
    exit 1
  fi
}

function main() {
  load_from_json_config

  check_input_params
  setup_bosh_env_vars

  if [ "$KEEP_ALIVE" = true ]; then
    ERRAND_PARAMS="$ERRAND_PARAMS --keep-alive"
  fi

  if [ -n "${INSTANCE}" ]; then
    ERRAND_PARAMS="${ERRAND_PARAMS} --instance=${INSTANCE}"
  fi

  bosh -d "${DEPLOYMENT_NAME}" run-errand "${ERRAND_NAME}" ${ERRAND_PARAMS}
}

main
